from fastapi import FastAPI,HTTPException,Depends,Request,Form
from fastapi.responses import HTMLResponse,RedirectResponse,JSONResponse
from fastapi.security import HTTPBasic,HTTPBasicCredentials
from contextlib import asynccontextmanager
import sqlite3,secrets,json,os,threading,httpx,asyncio
from datetime import datetime
from typing import Optional
ADMIN_USER=os.getenv("ADMIN_USER","admin")
ADMIN_PASS=os.getenv("ADMIN_PASS","admin123")
BOT_SECRET=os.getenv("BOT_SECRET","bot_secret_key_123")
DB_PATH=os.getenv("DB_PATH","data/config.db")
db_lock=threading.Lock()
def get_db():
 os.makedirs(os.path.dirname(DB_PATH)if os.path.dirname(DB_PATH)else".",exist_ok=True)
 conn=sqlite3.connect(DB_PATH,check_same_thread=False);conn.row_factory=sqlite3.Row;return conn
def init_db():
 conn=get_db()
 conn.executescript('''CREATE TABLE IF NOT EXISTS api_keys(id INTEGER PRIMARY KEY AUTOINCREMENT,name TEXT UNIQUE NOT NULL,key_value TEXT NOT NULL,enabled INTEGER DEFAULT 1,created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP);
CREATE TABLE IF NOT EXISTS models(id INTEGER PRIMARY KEY AUTOINCREMENT,model_id TEXT UNIQUE NOT NULL,name TEXT NOT NULL,emoji TEXT DEFAULT 'ðŸ¤–',description TEXT,provider TEXT NOT NULL,endpoint TEXT,model_name TEXT NOT NULL,category TEXT DEFAULT 'custom',enabled INTEGER DEFAULT 1,priority INTEGER DEFAULT 100,config TEXT DEFAULT '{}',created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP);
CREATE TABLE IF NOT EXISTS settings(key TEXT PRIMARY KEY,value TEXT NOT NULL,updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP);
CREATE TABLE IF NOT EXISTS logs(id INTEGER PRIMARY KEY AUTOINCREMENT,action TEXT NOT NULL,details TEXT,ip TEXT,created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP);''')
 defaults={"default_model":"groq","bot_prefix":".","rate_limit_ai":"5","rate_limit_img":"15","system_prompt":"You are a helpful AI assistant.","max_memory_messages":"25","memory_timeout_minutes":"30"}
 for k,v in defaults.items():conn.execute('INSERT OR IGNORE INTO settings(key,value)VALUES(?,?)',(k,v))
 conn.commit();conn.close()
@asynccontextmanager
async def lifespan(app:FastAPI):
 init_db();yield
app=FastAPI(title="Bot Config Panel",lifespan=lifespan)
security=HTTPBasic()
def verify_admin(credentials:HTTPBasicCredentials=Depends(security)):
 if not(secrets.compare_digest(credentials.username,ADMIN_USER)and secrets.compare_digest(credentials.password,ADMIN_PASS)):
  raise HTTPException(status_code=401,detail="Unauthorized",headers={"WWW-Authenticate":"Basic"})
 return credentials.username
def verify_bot(request:Request):
 auth=request.headers.get("X-Bot-Secret","")
 if not secrets.compare_digest(auth,BOT_SECRET):raise HTTPException(status_code=401,detail="Invalid bot secret")
 return True
def add_log(action:str,details:str="",ip:str=""):
 with db_lock:
  conn=get_db();conn.execute('INSERT INTO logs(action,details,ip)VALUES(?,?,?)',(action,details,ip))
  conn.execute('DELETE FROM logs WHERE id NOT IN(SELECT id FROM logs ORDER BY created_at DESC LIMIT 500)')
  conn.commit();conn.close()
AI_PROVIDERS={"groq":{"name":"Groq","test_url":"https://api.groq.com/openai/v1/models","auth":"Bearer","chat_url":"https://api.groq.com/openai/v1/chat/completions","models":["llama-3.3-70b-versatile","llama-3.1-70b-versatile","llama-3.1-8b-instant","mixtral-8x7b-32768","gemma2-9b-it"]},"openrouter":{"name":"OpenRouter","test_url":"https://openrouter.ai/api/v1/models","auth":"Bearer","chat_url":"https://openrouter.ai/api/v1/chat/completions","models":["meta-llama/llama-3.3-70b-instruct:free","google/gemini-2.0-flash-exp:free","qwen/qwen-2.5-72b-instruct:free","deepseek/deepseek-chat:free","mistralai/mistral-nemo:free"]},"cerebras":{"name":"Cerebras","test_url":"https://api.cerebras.ai/v1/models","auth":"Bearer","chat_url":"https://api.cerebras.ai/v1/chat/completions","models":["llama-3.3-70b","llama-3.1-8b"]},"sambanova":{"name":"SambaNova","test_url":"https://api.sambanova.ai/v1/models","auth":"Bearer","chat_url":"https://api.sambanova.ai/v1/chat/completions","models":["Meta-Llama-3.3-70B-Instruct","Meta-Llama-3.1-405B-Instruct","Meta-Llama-3.1-70B-Instruct"]},"together":{"name":"Together","test_url":"https://api.together.xyz/v1/models","auth":"Bearer","chat_url":"https://api.together.xyz/v1/chat/completions","models":["meta-llama/Llama-3.3-70B-Instruct-Turbo","meta-llama/Meta-Llama-3.1-405B-Instruct-Turbo","mistralai/Mixtral-8x7B-Instruct-v0.1"]},"mistral":{"name":"Mistral","test_url":"https://api.mistral.ai/v1/models","auth":"Bearer","chat_url":"https://api.mistral.ai/v1/chat/completions","models":["mistral-small-latest","mistral-medium-latest","mistral-large-latest","open-mistral-nemo"]},"cohere":{"name":"Cohere","test_url":"https://api.cohere.com/v1/models","auth":"bearer","chat_url":"https://api.cohere.com/v1/chat","models":["command-r-plus-08-2024","command-r-08-2024","command-light"]},"huggingface":{"name":"HuggingFace","test_url":"https://huggingface.co/api/whoami-v2","auth":"Bearer","chat_url":"https://api-inference.huggingface.co/models/","models":["mistralai/Mixtral-8x7B-Instruct-v0.1","meta-llama/Llama-2-70b-chat-hf","google/flan-t5-xxl"]},"openai":{"name":"OpenAI","test_url":"https://api.openai.com/v1/models","auth":"Bearer","chat_url":"https://api.openai.com/v1/chat/completions","models":["gpt-4o","gpt-4o-mini","gpt-4-turbo","gpt-3.5-turbo"]},"anthropic":{"name":"Anthropic","test_url":"https://api.anthropic.com/v1/messages","auth":"x-api-key","chat_url":"https://api.anthropic.com/v1/messages","models":["claude-3-5-sonnet-20241022","claude-3-opus-20240229","claude-3-haiku-20240307"]},"google":{"name":"Google AI","test_url":"https://generativelanguage.googleapis.com/v1/models","auth":"query","chat_url":"https://generativelanguage.googleapis.com/v1/models/","models":["gemini-1.5-pro","gemini-1.5-flash","gemini-pro"]},"deepseek":{"name":"DeepSeek","test_url":"https://api.deepseek.com/v1/models","auth":"Bearer","chat_url":"https://api.deepseek.com/v1/chat/completions","models":["deepseek-chat","deepseek-coder"]},"perplexity":{"name":"Perplexity","test_url":"https://api.perplexity.ai/chat/completions","auth":"Bearer","chat_url":"https://api.perplexity.ai/chat/completions","models":["llama-3.1-sonar-large-128k-online","llama-3.1-sonar-small-128k-online"]},"fireworks":{"name":"Fireworks","test_url":"https://api.fireworks.ai/inference/v1/models","auth":"Bearer","chat_url":"https://api.fireworks.ai/inference/v1/chat/completions","models":["accounts/fireworks/models/llama-v3p1-70b-instruct","accounts/fireworks/models/mixtral-8x7b-instruct"]},"replicate":{"name":"Replicate","test_url":"https://api.replicate.com/v1/models","auth":"Bearer","chat_url":"https://api.replicate.com/v1/predictions","models":["meta/meta-llama-3.1-405b-instruct","meta/meta-llama-3-70b-instruct"]},"tavily":{"name":"Tavily","test_url":"https://api.tavily.com/search","auth":"body","chat_url":"https://api.tavily.com/search","models":["search"]},"moonshot":{"name":"Moonshot","test_url":"https://api.moonshot.cn/v1/models","auth":"Bearer","chat_url":"https://api.moonshot.cn/v1/chat/completions","models":["moonshot-v1-8k","moonshot-v1-32k","moonshot-v1-128k"]}}
@app.get("/api/bot/keys")
async def bot_get_keys(request:Request,_:bool=Depends(verify_bot)):
 with db_lock:conn=get_db();rows=conn.execute('SELECT name,key_value FROM api_keys WHERE enabled=1').fetchall();conn.close()
 return{row["name"]:row["key_value"]for row in rows}
@app.get("/api/bot/key/{name}")
async def bot_get_key(name:str,request:Request,_:bool=Depends(verify_bot)):
 with db_lock:conn=get_db();row=conn.execute('SELECT key_value FROM api_keys WHERE name=? AND enabled=1',(name,)).fetchone();conn.close()
 if not row:raise HTTPException(status_code=404,detail="Key not found")
 return{"key":row["key_value"]}
@app.get("/api/bot/models")
async def bot_get_models(request:Request,_:bool=Depends(verify_bot)):
 with db_lock:conn=get_db();rows=conn.execute('SELECT model_id,name,emoji,description,provider,endpoint,model_name,category,config FROM models WHERE enabled=1 ORDER BY priority ASC').fetchall();conn.close()
 models={}
 for row in rows:models[row["model_id"]]={"e":row["emoji"],"n":row["name"],"d":row["description"]or"","c":row["category"],"p":row["provider"],"m":row["model_name"],"endpoint":row["endpoint"]or"","config":json.loads(row["config"]or"{}")}
 return models
@app.get("/api/bot/settings")
async def bot_get_settings(request:Request,_:bool=Depends(verify_bot)):
 with db_lock:conn=get_db();rows=conn.execute('SELECT key,value FROM settings').fetchall();conn.close()
 return{row["key"]:row["value"]for row in rows}
@app.get("/api/bot/setting/{key}")
async def bot_get_setting(key:str,request:Request,_:bool=Depends(verify_bot)):
 with db_lock:conn=get_db();row=conn.execute('SELECT value FROM settings WHERE key=?',(key,)).fetchone();conn.close()
 if not row:raise HTTPException(status_code=404,detail="Setting not found")
 return{"value":row["value"]}
@app.get("/api/bot/config")
async def bot_get_full_config(request:Request,_:bool=Depends(verify_bot)):
 with db_lock:
  conn=get_db()
  keys={row["name"]:row["key_value"]for row in conn.execute('SELECT name,key_value FROM api_keys WHERE enabled=1').fetchall()}
  models={}
  for row in conn.execute('SELECT*FROM models WHERE enabled=1 ORDER BY priority ASC').fetchall():
   models[row["model_id"]]={"e":row["emoji"],"n":row["name"],"d":row["description"]or"","c":row["category"],"p":row["provider"],"m":row["model_name"],"endpoint":row["endpoint"]or"","config":json.loads(row["config"]or"{}")}
  settings={row["key"]:row["value"]for row in conn.execute('SELECT key,value FROM settings').fetchall()}
  conn.close()
 return{"keys":keys,"models":models,"settings":settings,"timestamp":datetime.now().isoformat()}
@app.post("/api/bot/ping")
async def bot_ping(request:Request,_:bool=Depends(verify_bot)):
 add_log("bot_ping","",request.client.host if request.client else"");return{"status":"ok","timestamp":datetime.now().isoformat()}
@app.get("/api/admin/keys")
async def admin_list_keys(user:str=Depends(verify_admin)):
 with db_lock:conn=get_db();rows=conn.execute('SELECT id,name,key_value,enabled,created_at,updated_at FROM api_keys ORDER BY name').fetchall();conn.close()
 return[dict(row)for row in rows]
@app.post("/api/admin/keys")
async def admin_add_key(request:Request,user:str=Depends(verify_admin)):
 data=await request.json();name=data.get("name","").strip().lower();key_value=data.get("key","").strip()
 if not name or not key_value:raise HTTPException(status_code=400,detail="Name and key required")
 with db_lock:
  conn=get_db()
  try:conn.execute('INSERT INTO api_keys(name,key_value)VALUES(?,?)',(name,key_value));conn.commit()
  except sqlite3.IntegrityError:conn.close();raise HTTPException(status_code=400,detail="Key name already exists")
  conn.close()
 add_log("add_key",f"Added key:{name}",request.client.host if request.client else"");return{"success":True,"message":f"Key '{name}' added"}
@app.put("/api/admin/keys/{key_id}")
async def admin_update_key(key_id:int,request:Request,user:str=Depends(verify_admin)):
 data=await request.json();key_value=data.get("key","").strip();enabled=data.get("enabled")
 with db_lock:
  conn=get_db()
  if key_value:conn.execute('UPDATE api_keys SET key_value=?,updated_at=CURRENT_TIMESTAMP WHERE id=?',(key_value,key_id))
  if enabled is not None:conn.execute('UPDATE api_keys SET enabled=?,updated_at=CURRENT_TIMESTAMP WHERE id=?',(1 if enabled else 0,key_id))
  conn.commit();conn.close()
 add_log("update_key",f"Updated key ID:{key_id}",request.client.host if request.client else"");return{"success":True}
@app.delete("/api/admin/keys/{key_id}")
async def admin_delete_key(key_id:int,request:Request,user:str=Depends(verify_admin)):
 with db_lock:conn=get_db();conn.execute('DELETE FROM api_keys WHERE id=?',(key_id,));conn.commit();conn.close()
 add_log("delete_key",f"Deleted key ID:{key_id}",request.client.host if request.client else"");return{"success":True,"message":"Key deleted"}
@app.get("/api/admin/models")
async def admin_list_models(user:str=Depends(verify_admin)):
 with db_lock:conn=get_db();rows=conn.execute('SELECT*FROM models ORDER BY category,priority,name').fetchall();conn.close()
 return[dict(row)for row in rows]
@app.post("/api/admin/models")
async def admin_add_model(request:Request,user:str=Depends(verify_admin)):
 data=await request.json()
 for field in["model_id","name","provider","model_name"]:
  if not data.get(field):raise HTTPException(status_code=400,detail=f"Field '{field}' required")
 with db_lock:
  conn=get_db()
  try:
   conn.execute('INSERT INTO models(model_id,name,emoji,description,provider,endpoint,model_name,category,priority,config)VALUES(?,?,?,?,?,?,?,?,?,?)',(data["model_id"],data["name"],data.get("emoji","ðŸ¤–"),data.get("description",""),data["provider"],data.get("endpoint",""),data["model_name"],data.get("category","custom"),data.get("priority",100),json.dumps(data.get("config",{}))))
   conn.commit()
  except sqlite3.IntegrityError:conn.close();raise HTTPException(status_code=400,detail="Model ID already exists")
  conn.close()
 add_log("add_model",f"Added model:{data['model_id']}",request.client.host if request.client else"");return{"success":True}
@app.put("/api/admin/models/{model_id}")
async def admin_update_model(model_id:int,request:Request,user:str=Depends(verify_admin)):
 data=await request.json();fields=[];values=[]
 for key in["name","emoji","description","provider","endpoint","model_name","category","priority","enabled"]:
  if key in data:fields.append(f"{key}=?");values.append(data[key])
 if"config"in data:fields.append("config=?");values.append(json.dumps(data["config"]))
 if not fields:raise HTTPException(status_code=400,detail="No fields to update")
 values.append(model_id)
 with db_lock:conn=get_db();conn.execute(f'UPDATE models SET {",".join(fields)} WHERE id=?',values);conn.commit();conn.close()
 add_log("update_model",f"Updated model ID:{model_id}",request.client.host if request.client else"");return{"success":True}
@app.delete("/api/admin/models/{model_id}")
async def admin_delete_model(model_id:int,request:Request,user:str=Depends(verify_admin)):
 with db_lock:conn=get_db();conn.execute('DELETE FROM models WHERE id=?',(model_id,));conn.commit();conn.close()
 add_log("delete_model",f"Deleted model ID:{model_id}",request.client.host if request.client else"");return{"success":True,"message":"Model deleted"}
@app.get("/api/admin/settings")
async def admin_list_settings(user:str=Depends(verify_admin)):
 with db_lock:conn=get_db();rows=conn.execute('SELECT*FROM settings ORDER BY key').fetchall();conn.close()
 return[dict(row)for row in rows]
@app.put("/api/admin/settings/{key}")
async def admin_update_setting(key:str,request:Request,user:str=Depends(verify_admin)):
 data=await request.json();value=data.get("value","")
 with db_lock:conn=get_db();conn.execute('INSERT OR REPLACE INTO settings(key,value,updated_at)VALUES(?,?,CURRENT_TIMESTAMP)',(key,value));conn.commit();conn.close()
 add_log("update_setting",f"Updated:{key}",request.client.host if request.client else"");return{"success":True}
@app.get("/api/admin/logs")
async def admin_list_logs(user:str=Depends(verify_admin)):
 with db_lock:conn=get_db();rows=conn.execute('SELECT*FROM logs ORDER BY created_at DESC LIMIT 100').fetchall();conn.close()
 return[dict(row)for row in rows]
@app.get("/api/admin/providers")
async def admin_get_providers(user:str=Depends(verify_admin)):
 return AI_PROVIDERS
@app.post("/api/admin/test-key")
async def admin_test_key(request:Request,user:str=Depends(verify_admin)):
 data=await request.json();provider=data.get("provider","");key=data.get("key","")
 if provider not in AI_PROVIDERS:return{"success":True,"message":"Provider not in test list, assuming valid","tested":False}
 prov=AI_PROVIDERS[provider]
 try:
  async with httpx.AsyncClient()as client:
   headers={};params={}
   if prov["auth"]=="Bearer":headers["Authorization"]=f"Bearer {key}"
   elif prov["auth"]=="bearer":headers["Authorization"]=f"bearer {key}"
   elif prov["auth"]=="x-api-key":headers["x-api-key"]=key;headers["anthropic-version"]="2023-06-01"
   elif prov["auth"]=="query":params["key"]=key
   elif prov["auth"]=="body":
    resp=await client.post(prov["test_url"],json={"api_key":key,"query":"test","max_results":1},timeout=10)
    return{"success":resp.status_code==200,"message":"API key valid"if resp.status_code==200 else f"HTTP {resp.status_code}","tested":True}
   resp=await client.get(prov["test_url"],headers=headers,params=params,timeout=10)
   if resp.status_code==200:return{"success":True,"message":"API key is valid âœ“","tested":True}
   elif resp.status_code==401:return{"success":False,"message":"Invalid API key âœ—","tested":True}
   else:return{"success":False,"message":f"HTTP {resp.status_code}","tested":True}
 except Exception as e:return{"success":False,"message":str(e)[:100],"tested":True}
@app.post("/api/admin/test-model")
async def admin_test_model(request:Request,user:str=Depends(verify_admin)):
 data=await request.json();provider=data.get("provider","");key=data.get("key","");model=data.get("model","")
 if not key or not model:return{"success":False,"message":"Key and model required"}
 if provider not in AI_PROVIDERS:return{"success":False,"message":"Unknown provider"}
 prov=AI_PROVIDERS[provider]
 try:
  async with httpx.AsyncClient()as client:
   headers={"Content-Type":"application/json"}
   if prov["auth"]=="Bearer":headers["Authorization"]=f"Bearer {key}"
   elif prov["auth"]=="bearer":headers["Authorization"]=f"bearer {key}"
   elif prov["auth"]=="x-api-key":headers["x-api-key"]=key;headers["anthropic-version"]="2023-06-01"
   if provider=="cohere":
    resp=await client.post(prov["chat_url"],headers=headers,json={"model":model,"message":"Say OK"},timeout=30)
   elif provider=="anthropic":
    resp=await client.post(prov["chat_url"],headers=headers,json={"model":model,"max_tokens":10,"messages":[{"role":"user","content":"Say OK"}]},timeout=30)
   elif provider=="google":
    resp=await client.post(f"{prov['chat_url']}{model}:generateContent?key={key}",json={"contents":[{"parts":[{"text":"Say OK"}]}]},timeout=30)
   elif provider=="tavily":
    resp=await client.post(prov["chat_url"],json={"api_key":key,"query":"test","max_results":1},timeout=30)
   elif provider=="huggingface":
    resp=await client.post(f"{prov['chat_url']}{model}",headers=headers,json={"inputs":"Say OK"},timeout=30)
   else:
    resp=await client.post(prov["chat_url"],headers=headers,json={"model":model,"messages":[{"role":"user","content":"Say OK"}],"max_tokens":10},timeout=30)
   if resp.status_code==200:
    try:
     result=resp.json()
     if"choices"in result or"text"in result or"response"in result or"output"in result or"results"in result or"candidates"in result:return{"success":True,"message":f"Model '{model}' working âœ“","response":str(result)[:200]}
    except:pass
    return{"success":True,"message":f"Model '{model}' responded","response":resp.text[:200]}
   else:return{"success":False,"message":f"HTTP {resp.status_code}: {resp.text[:100]}"}
 except Exception as e:return{"success":False,"message":str(e)[:100]}
@app.post("/api/admin/test-all-keys")
async def admin_test_all_keys(request:Request,user:str=Depends(verify_admin)):
 with db_lock:conn=get_db();rows=conn.execute('SELECT name,key_value FROM api_keys WHERE enabled=1').fetchall();conn.close()
 results={}
 async with httpx.AsyncClient()as client:
  for row in rows:
   name=row["name"];key=row["key_value"]
   if name not in AI_PROVIDERS:results[name]={"success":True,"message":"Not testable","tested":False};continue
   prov=AI_PROVIDERS[name]
   try:
    headers={};params={}
    if prov["auth"]=="Bearer":headers["Authorization"]=f"Bearer {key}"
    elif prov["auth"]=="bearer":headers["Authorization"]=f"bearer {key}"
    elif prov["auth"]=="x-api-key":headers["x-api-key"]=key;headers["anthropic-version"]="2023-06-01"
    elif prov["auth"]=="query":params["key"]=key
    elif prov["auth"]=="body":
     resp=await client.post(prov["test_url"],json={"api_key":key,"query":"test","max_results":1},timeout=10)
     results[name]={"success":resp.status_code==200,"message":"Valid"if resp.status_code==200 else"Invalid","tested":True}
     continue
    resp=await client.get(prov["test_url"],headers=headers,params=params,timeout=10)
    results[name]={"success":resp.status_code==200,"message":"Valid âœ“"if resp.status_code==200 else f"Error:{resp.status_code}","tested":True}
   except Exception as e:results[name]={"success":False,"message":str(e)[:50],"tested":True}
 return results
@app.get("/health")
async def health_check():return{"status":"ok","timestamp":datetime.now().isoformat()}
def get_html():
 return'''<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"><title>Bot Config Panel</title><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"><link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet"><style>:root{--primary:#5865F2;--dark:#1a1a2e;--darker:#16213e;--accent:#0f3460}body{background:linear-gradient(135deg,var(--dark)0%,var(--darker)100%);min-height:100vh;color:#fff}.navbar{background:rgba(0,0,0,0.3)!important;backdrop-filter:blur(10px)}.card{background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:15px}.card-header{background:rgba(255,255,255,0.05);border-bottom:1px solid rgba(255,255,255,0.1)}.table{color:#fff}.table-dark{background:transparent}.table-dark td,.table-dark th{border-color:rgba(255,255,255,0.1);background:transparent}.btn-primary{background:var(--primary);border:none}.btn-primary:hover{background:#4752c4}.form-control,.form-select{background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:#fff}.form-control:focus,.form-select:focus{background:rgba(255,255,255,0.15);border-color:var(--primary);color:#fff;box-shadow:0 0 0 0.25rem rgba(88,101,242,0.25)}.form-control::placeholder{color:rgba(255,255,255,0.5)}.modal-content{background:var(--darker);border:1px solid rgba(255,255,255,0.1)}.nav-pills .nav-link{color:rgba(255,255,255,0.7)}.nav-pills .nav-link.active{background:var(--primary)}.badge-enabled{background:#2ecc71}.badge-disabled{background:#e74c3c}.key-hidden{font-family:monospace;background:rgba(0,0,0,0.3);padding:2px 8px;border-radius:4px}.toast-container{position:fixed;top:20px;right:20px;z-index:9999}.test-result{font-size:0.85rem;padding:4px 8px;border-radius:4px;margin-top:4px}.test-success{background:rgba(46,204,113,0.2);color:#2ecc71}.test-fail{background:rgba(231,76,60,0.2);color:#e74c3c}.test-pending{background:rgba(241,196,15,0.2);color:#f1c40f}.provider-card{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.1);border-radius:10px;padding:15px;margin-bottom:10px}.provider-card:hover{background:rgba(255,255,255,0.05)}</style></head><body><nav class="navbar navbar-expand-lg navbar-dark mb-4"><div class="container"><a class="navbar-brand" href="#"><i class="bi bi-gear-fill me-2"></i>Bot Config Panel</a><div class="navbar-nav ms-auto"><button class="btn btn-outline-light btn-sm me-2" onclick="testAllKeys()"><i class="bi bi-check-circle me-1"></i>Test All Keys</button><span class="nav-link" id="status-indicator"><i class="bi bi-circle-fill text-success me-1"></i>Connected</span></div></div></nav><div class="container pb-5"><ul class="nav nav-pills mb-4" id="mainTab" role="tablist"><li class="nav-item"><a class="nav-link active" data-bs-toggle="pill" href="#keys"><i class="bi bi-key me-1"></i>API Keys</a></li><li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#models"><i class="bi bi-robot me-1"></i>Models</a></li><li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#settings"><i class="bi bi-sliders me-1"></i>Settings</a></li><li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#test"><i class="bi bi-speedometer2 me-1"></i>API Tester</a></li><li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#logs"><i class="bi bi-list-ul me-1"></i>Logs</a></li></ul><div class="tab-content"><div class="tab-pane fade show active" id="keys"><div class="card"><div class="card-header d-flex justify-content-between align-items-center"><h5 class="mb-0"><i class="bi bi-key me-2"></i>API Keys</h5><button class="btn btn-primary btn-sm" onclick="showAddKeyModal()"><i class="bi bi-plus-lg me-1"></i>Add Key</button></div><div class="card-body"><div class="table-responsive"><table class="table table-dark table-hover"><thead><tr><th>Provider</th><th>Key</th><th>Status</th><th>Test</th><th>Updated</th><th>Actions</th></tr></thead><tbody id="keys-table"></tbody></table></div></div></div></div><div class="tab-pane fade" id="models"><div class="card"><div class="card-header d-flex justify-content-between align-items-center"><h5 class="mb-0"><i class="bi bi-robot me-2"></i>AI Models</h5><button class="btn btn-primary btn-sm" onclick="showAddModelModal()"><i class="bi bi-plus-lg me-1"></i>Add Model</button></div><div class="card-body"><div class="table-responsive"><table class="table table-dark table-hover"><thead><tr><th>ID</th><th>Name</th><th>Provider</th><th>Model</th><th>Category</th><th>Status</th><th>Actions</th></tr></thead><tbody id="models-table"></tbody></table></div></div></div></div><div class="tab-pane fade" id="settings"><div class="card"><div class="card-header"><h5 class="mb-0"><i class="bi bi-sliders me-2"></i>Bot Settings</h5></div><div class="card-body"><form id="settings-form"><div class="row g-3" id="settings-fields"></div><div class="mt-4"><button type="submit" class="btn btn-primary"><i class="bi bi-save me-1"></i>Save All Settings</button></div></form></div></div></div><div class="tab-pane fade" id="test"><div class="card"><div class="card-header"><h5 class="mb-0"><i class="bi bi-speedometer2 me-2"></i>API Tester</h5></div><div class="card-body"><div class="row mb-4"><div class="col-md-4"><label class="form-label">Provider</label><select class="form-select" id="test-provider" onchange="loadProviderModels()"><option value="">Select provider...</option></select></div><div class="col-md-4"><label class="form-label">API Key</label><input type="text" class="form-control" id="test-key" placeholder="Enter API key or leave empty to use saved"></div><div class="col-md-4"><label class="form-label">Model</label><select class="form-select" id="test-model"><option value="">Select model...</option></select></div></div><div class="row mb-3"><div class="col-12 d-flex gap-2"><button class="btn btn-info" onclick="testApiKey()"><i class="bi bi-key me-1"></i>Test API Key</button><button class="btn btn-success" onclick="testModel()"><i class="bi bi-robot me-1"></i>Test Model</button><button class="btn btn-secondary" onclick="clearTestResult()"><i class="bi bi-x-circle me-1"></i>Clear</button></div></div><div id="test-result" class="p-3 rounded" style="background:rgba(0,0,0,0.2);min-height:100px;display:none"><pre style="color:#fff;margin:0;white-space:pre-wrap" id="test-result-text"></pre></div><hr class="my-4"><h6><i class="bi bi-list-check me-2"></i>Available Providers & Models</h6><div class="row" id="providers-list"></div></div></div></div><div class="tab-pane fade" id="logs"><div class="card"><div class="card-header d-flex justify-content-between align-items-center"><h5 class="mb-0"><i class="bi bi-list-ul me-2"></i>Activity Logs</h5><button class="btn btn-outline-light btn-sm" onclick="loadLogs()"><i class="bi bi-arrow-clockwise"></i></button></div><div class="card-body"><div class="table-responsive" style="max-height:500px;overflow-y:auto"><table class="table table-dark table-sm"><thead><tr><th>Time</th><th>Action</th><th>Details</th><th>IP</th></tr></thead><tbody id="logs-table"></tbody></table></div></div></div></div></div></div><div class="modal fade" id="addKeyModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title"><i class="bi bi-key me-2"></i>Add API Key</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><form id="add-key-form"><div class="modal-body"><div class="mb-3"><label class="form-label">Provider Name</label><select class="form-select" id="key-name" required><option value="">Select provider...</option></select></div><div class="mb-3"><label class="form-label">API Key</label><input type="text" class="form-control" id="key-value" required placeholder="sk-xxxxx..."></div><div id="add-key-test-result"></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="button" class="btn btn-info" onclick="testNewKey()"><i class="bi bi-check-circle me-1"></i>Test</button><button type="submit" class="btn btn-primary"><i class="bi bi-plus-lg me-1"></i>Add</button></div></form></div></div></div><div class="modal fade" id="editKeyModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title"><i class="bi bi-pencil me-2"></i>Edit API Key</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><form id="edit-key-form"><div class="modal-body"><input type="hidden" id="edit-key-id"><div class="mb-3"><label class="form-label">Provider</label><input type="text" class="form-control" id="edit-key-name" readonly></div><div class="mb-3"><label class="form-label">New API Key</label><input type="text" class="form-control" id="edit-key-value" placeholder="Leave blank to keep current"></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="submit" class="btn btn-primary"><i class="bi bi-save me-1"></i>Save</button></div></form></div></div></div><div class="modal fade" id="addModelModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title"><i class="bi bi-robot me-2"></i>Add Model</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><form id="add-model-form"><div class="modal-body"><div class="row g-3"><div class="col-md-6"><label class="form-label">Model ID</label><input type="text" class="form-control" id="model-id" required placeholder="my_custom_model"></div><div class="col-md-4"><label class="form-label">Display Name</label><input type="text" class="form-control" id="model-name" required placeholder="My Model"></div><div class="col-md-2"><label class="form-label">Emoji</label><input type="text" class="form-control" id="model-emoji" value="ðŸ¤–" maxlength="2"></div><div class="col-md-6"><label class="form-label">Provider</label><select class="form-select" id="model-provider" required></select></div><div class="col-md-6"><label class="form-label">Category</label><select class="form-select" id="model-category"><option value="main">Main</option><option value="openrouter">OpenRouter</option><option value="pollinations">Pollinations</option><option value="custom">Custom</option></select></div><div class="col-md-8"><label class="form-label">Model Name (API)</label><input type="text" class="form-control" id="model-model-name" required placeholder="llama-3.3-70b-versatile"></div><div class="col-md-4"><label class="form-label">Priority</label><input type="number" class="form-control" id="model-priority" value="100"></div><div class="col-12"><label class="form-label">Custom Endpoint (optional)</label><input type="text" class="form-control" id="model-endpoint" placeholder="https://api.example.com/v1/chat/completions"></div><div class="col-12"><label class="form-label">Description</label><input type="text" class="form-control" id="model-description" placeholder="Fast and accurate"></div></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="submit" class="btn btn-primary"><i class="bi bi-plus-lg me-1"></i>Add Model</button></div></form></div></div></div><div class="modal fade" id="editModelModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title"><i class="bi bi-pencil me-2"></i>Edit Model</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><form id="edit-model-form"><div class="modal-body"><input type="hidden" id="edit-model-db-id"><div class="row g-3"><div class="col-md-6"><label class="form-label">Model ID</label><input type="text" class="form-control" id="edit-model-id" readonly></div><div class="col-md-4"><label class="form-label">Display Name</label><input type="text" class="form-control" id="edit-model-name" required></div><div class="col-md-2"><label class="form-label">Emoji</label><input type="text" class="form-control" id="edit-model-emoji" maxlength="2"></div><div class="col-md-6"><label class="form-label">Provider</label><select class="form-select" id="edit-model-provider" required></select></div><div class="col-md-6"><label class="form-label">Category</label><select class="form-select" id="edit-model-category"><option value="main">Main</option><option value="openrouter">OpenRouter</option><option value="pollinations">Pollinations</option><option value="custom">Custom</option></select></div><div class="col-md-8"><label class="form-label">Model Name (API)</label><input type="text" class="form-control" id="edit-model-model-name" required></div><div class="col-md-4"><label class="form-label">Priority</label><input type="number" class="form-control" id="edit-model-priority"></div><div class="col-12"><label class="form-label">Custom Endpoint</label><input type="text" class="form-control" id="edit-model-endpoint"></div><div class="col-12"><label class="form-label">Description</label><input type="text" class="form-control" id="edit-model-description"></div></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="submit" class="btn btn-primary"><i class="bi bi-save me-1"></i>Save</button></div></form></div></div></div><div class="toast-container" id="toast-container"></div><script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script><script>let providers={};function showToast(message,type='success'){const container=document.getElementById('toast-container');const toast=document.createElement('div');toast.className=`toast show bg-${type==='success'?'success':'danger'} text-white`;toast.innerHTML=`<div class="toast-body d-flex justify-content-between align-items-center">${message}<button class="btn-close btn-close-white ms-2" onclick="this.parentElement.parentElement.remove()"></button></div>`;container.appendChild(toast);setTimeout(()=>toast.remove(),3000)}async function api(method,endpoint,data=null){const options={method,headers:{'Content-Type':'application/json'}};if(data)options.body=JSON.stringify(data);const resp=await fetch(`/api/admin${endpoint}`,options);if(resp.status===401){window.location.reload();return null}return resp.json()}async function loadProviders(){providers=await api('GET','/providers');const sel1=document.getElementById('key-name');const sel2=document.getElementById('test-provider');const sel3=document.getElementById('model-provider');const sel4=document.getElementById('edit-model-provider');sel1.innerHTML='<option value="">Select provider...</option>';sel2.innerHTML='<option value="">Select provider...</option>';sel3.innerHTML='';sel4.innerHTML='';for(const[k,v]of Object.entries(providers)){sel1.innerHTML+=`<option value="${k}">${v.name}</option>`;sel2.innerHTML+=`<option value="${k}">${v.name}</option>`;sel3.innerHTML+=`<option value="${k}">${v.name}</option>`;sel4.innerHTML+=`<option value="${k}">${v.name}</option>`}const list=document.getElementById('providers-list');list.innerHTML='';for(const[k,v]of Object.entries(providers)){list.innerHTML+=`<div class="col-md-6 col-lg-4"><div class="provider-card"><h6>${v.name}</h6><small class="text-muted">Models:</small><ul class="mb-0 ps-3" style="font-size:0.8rem">${v.models.slice(0,3).map(m=>`<li><code>${m}</code></li>`).join('')}${v.models.length>3?`<li>+${v.models.length-3} more</li>`:''}</ul></div></div>`}}function loadProviderModels(){const prov=document.getElementById('test-provider').value;const sel=document.getElementById('test-model');sel.innerHTML='<option value="">Select model...</option>';if(prov&&providers[prov]){providers[prov].models.forEach(m=>{sel.innerHTML+=`<option value="${m}">${m}</option>`})}}async function loadKeys(){const keys=await api('GET','/keys');const tbody=document.getElementById('keys-table');tbody.innerHTML=keys.map(k=>`<tr><td><strong>${k.name}</strong></td><td><span class="key-hidden">â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢${(k.key_value||'').slice(-4)}</span><button class="btn btn-sm btn-link text-light p-0 ms-2" onclick="copyKey('${k.key_value}')"><i class="bi bi-clipboard"></i></button></td><td><span class="badge ${k.enabled?'badge-enabled':'badge-disabled'}">${k.enabled?'Enabled':'Disabled'}</span></td><td><button class="btn btn-sm btn-outline-info" onclick="testSingleKey('${k.name}','${k.key_value}',this)"><i class="bi bi-play"></i></button><span class="test-status-${k.id}"></span></td><td>${new Date(k.updated_at).toLocaleDateString()}</td><td><button class="btn btn-sm btn-outline-light me-1" onclick="toggleKey(${k.id},${!k.enabled})"><i class="bi bi-power"></i></button><button class="btn btn-sm btn-outline-primary me-1" onclick="showEditKeyModal(${k.id},'${k.name}')"><i class="bi bi-pencil"></i></button><button class="btn btn-sm btn-outline-danger" onclick="deleteKey(${k.id},'${k.name}')"><i class="bi bi-trash"></i></button></td></tr>`).join('')}function copyKey(key){navigator.clipboard.writeText(key);showToast('Key copied!')}function showAddKeyModal(){document.getElementById('add-key-form').reset();document.getElementById('add-key-test-result').innerHTML='';new bootstrap.Modal(document.getElementById('addKeyModal')).show()}document.getElementById('add-key-form').addEventListener('submit',async(e)=>{e.preventDefault();const result=await api('POST','/keys',{name:document.getElementById('key-name').value,key:document.getElementById('key-value').value});if(result&&result.success){showToast('API key added successfully');bootstrap.Modal.getInstance(document.getElementById('addKeyModal')).hide();loadKeys()}else{showToast(result?.detail||'Error adding key','error')}});async function testNewKey(){const prov=document.getElementById('key-name').value;const key=document.getElementById('key-value').value;if(!prov||!key)return showToast('Select provider and enter key','error');document.getElementById('add-key-test-result').innerHTML='<div class="test-result test-pending">Testing...</div>';const result=await api('POST','/test-key',{provider:prov,key});document.getElementById('add-key-test-result').innerHTML=`<div class="test-result ${result.success?'test-success':'test-fail'}">${result.message}</div>`}async function testSingleKey(prov,key,btn){btn.disabled=true;btn.innerHTML='<i class="bi bi-hourglass-split"></i>';const result=await api('POST','/test-key',{provider:prov,key});btn.disabled=false;btn.innerHTML=result.success?'<i class="bi bi-check-lg text-success"></i>':'<i class="bi bi-x-lg text-danger"></i>';setTimeout(()=>{btn.innerHTML='<i class="bi bi-play"></i>'},3000)}function showEditKeyModal(id,name){document.getElementById('edit-key-id').value=id;document.getElementById('edit-key-name').value=name;document.getElementById('edit-key-value').value='';new bootstrap.Modal(document.getElementById('editKeyModal')).show()}document.getElementById('edit-key-form').addEventListener('submit',async(e)=>{e.preventDefault();const id=document.getElementById('edit-key-id').value;const key=document.getElementById('edit-key-value').value;if(key){await api('PUT',`/keys/${id}`,{key});showToast('API key updated');bootstrap.Modal.getInstance(document.getElementById('editKeyModal')).hide();loadKeys()}else{showToast('Enter new key value','error')}});async function toggleKey(id,enabled){await api('PUT',`/keys/${id}`,{enabled});loadKeys();showToast(enabled?'Key enabled':'Key disabled')}async function deleteKey(id,name){if(confirm(`Delete API key "${name}"? This cannot be undone.`)){const result=await api('DELETE',`/keys/${id}`);if(result&&result.success){showToast('API key deleted');loadKeys()}else{showToast('Error deleting key','error')}}}async function testAllKeys(){showToast('Testing all keys...');const results=await api('POST','/test-all-keys');let msg='Test Results:\\n';for(const[k,v]of Object.entries(results)){msg+=`${v.success?'âœ“':'âœ—'} ${k}: ${v.message}\\n`}alert(msg)}async function loadModels(){const models=await api('GET','/models');const tbody=document.getElementById('models-table');tbody.innerHTML=models.map(m=>`<tr><td><code>${m.model_id}</code></td><td>${m.emoji} ${m.name}</td><td>${m.provider}</td><td><small class="text-muted">${(m.model_name||'').substring(0,25)}...</small></td><td><span class="badge bg-secondary">${m.category}</span></td><td><span class="badge ${m.enabled?'badge-enabled':'badge-disabled'}">${m.enabled?'On':'Off'}</span></td><td><button class="btn btn-sm btn-outline-light me-1" onclick="toggleModel(${m.id},${!m.enabled})"><i class="bi bi-power"></i></button><button class="btn btn-sm btn-outline-primary me-1" onclick='showEditModelModal(${JSON.stringify(m).replace(/'/g,"&#39;")})'><i class="bi bi-pencil"></i></button><button class="btn btn-sm btn-outline-danger" onclick="deleteModel(${m.id},'${m.name}')"><i class="bi bi-trash"></i></button></td></tr>`).join('')}function showAddModelModal(){document.getElementById('add-model-form').reset();document.getElementById('model-emoji').value='ðŸ¤–';document.getElementById('model-priority').value=100;new bootstrap.Modal(document.getElementById('addModelModal')).show()}document.getElementById('add-model-form').addEventListener('submit',async(e)=>{e.preventDefault();const result=await api('POST','/models',{model_id:document.getElementById('model-id').value,name:document.getElementById('model-name').value,emoji:document.getElementById('model-emoji').value,provider:document.getElementById('model-provider').value,model_name:document.getElementById('model-model-name').value,category:document.getElementById('model-category').value,priority:parseInt(document.getElementById('model-priority').value),endpoint:document.getElementById('model-endpoint').value,description:document.getElementById('model-description').value});if(result&&result.success){showToast('Model added successfully');bootstrap.Modal.getInstance(document.getElementById('addModelModal')).hide();loadModels()}else{showToast(result?.detail||'Error adding model','error')}});function showEditModelModal(model){document.getElementById('edit-model-db-id').value=model.id;document.getElementById('edit-model-id').value=model.model_id;document.getElementById('edit-model-name').value=model.name;document.getElementById('edit-model-emoji').value=model.emoji;document.getElementById('edit-model-provider').value=model.provider;document.getElementById('edit-model-model-name').value=model.model_name;document.getElementById('edit-model-category').value=model.category;document.getElementById('edit-model-priority').value=model.priority;document.getElementById('edit-model-endpoint').value=model.endpoint||'';document.getElementById('edit-model-description').value=model.description||'';new bootstrap.Modal(document.getElementById('editModelModal')).show()}document.getElementById('edit-model-form').addEventListener('submit',async(e)=>{e.preventDefault();const id=document.getElementById('edit-model-db-id').value;await api('PUT',`/models/${id}`,{name:document.getElementById('edit-model-name').value,emoji:document.getElementById('edit-model-emoji').value,provider:document.getElementById('edit-model-provider').value,model_name:document.getElementById('edit-model-model-name').value,category:document.getElementById('edit-model-category').value,priority:parseInt(document.getElementById('edit-model-priority').value),endpoint:document.getElementById('edit-model-endpoint').value,description:document.getElementById('edit-model-description').value});showToast('Model updated');bootstrap.Modal.getInstance(document.getElementById('editModelModal')).hide();loadModels()});async function toggleModel(id,enabled){await api('PUT',`/models/${id}`,{enabled:enabled?1:0});loadModels()}async function deleteModel(id,name){if(confirm(`Delete model "${name}"? This cannot be undone.`)){const result=await api('DELETE',`/models/${id}`);if(result&&result.success){showToast('Model deleted');loadModels()}else{showToast('Error deleting model','error')}}}const settingsInfo={default_model:{label:'Default AI Model',type:'text',help:'Model ID for public users'},bot_prefix:{label:'Bot Prefix',type:'text',help:'Command prefix'},rate_limit_ai:{label:'AI Rate Limit (seconds)',type:'number',help:'Cooldown between AI commands'},rate_limit_img:{label:'Image Rate Limit (seconds)',type:'number',help:'Cooldown between image commands'},system_prompt:{label:'System Prompt',type:'textarea',help:'Base instruction for AI'},max_memory_messages:{label:'Max Memory Messages',type:'number',help:'Messages to remember'},memory_timeout_minutes:{label:'Memory Timeout (minutes)',type:'number',help:'Memory expiry time'}};async function loadSettings(){const settings=await api('GET','/settings');const container=document.getElementById('settings-fields');container.innerHTML=settings.map(s=>{const info=settingsInfo[s.key]||{label:s.key,type:'text',help:''};if(info.type==='textarea'){return`<div class="col-12"><label class="form-label">${info.label}</label><textarea class="form-control" name="${s.key}" rows="3">${s.value}</textarea><small class="text-muted">${info.help}</small></div>`}return`<div class="col-md-6"><label class="form-label">${info.label}</label><input type="${info.type}" class="form-control" name="${s.key}" value="${s.value}"><small class="text-muted">${info.help}</small></div>`}).join('')}document.getElementById('settings-form').addEventListener('submit',async(e)=>{e.preventDefault();const formData=new FormData(e.target);for(const[key,value]of formData.entries()){await api('PUT',`/settings/${key}`,{value})}showToast('Settings saved successfully')});async function loadLogs(){const logs=await api('GET','/logs');const tbody=document.getElementById('logs-table');tbody.innerHTML=logs.map(l=>`<tr><td><small>${new Date(l.created_at).toLocaleString()}</small></td><td><code>${l.action}</code></td><td><small>${l.details||'-'}</small></td><td><small class="text-muted">${l.ip||'-'}</small></td></tr>`).join('')}async function testApiKey(){const prov=document.getElementById('test-provider').value;let key=document.getElementById('test-key').value;if(!prov)return showToast('Select a provider','error');if(!key){const keys=await api('GET','/keys');const found=keys.find(k=>k.name===prov);if(found)key=found.key_value;else return showToast('No saved key for this provider','error')}showTestResult('Testing API key...',true);const result=await api('POST','/test-key',{provider:prov,key});showTestResult(`API Key Test: ${result.message}`,!result.success)}async function testModel(){const prov=document.getElementById('test-provider').value;const model=document.getElementById('test-model').value;let key=document.getElementById('test-key').value;if(!prov||!model)return showToast('Select provider and model','error');if(!key){const keys=await api('GET','/keys');const found=keys.find(k=>k.name===prov);if(found)key=found.key_value;else return showToast('No saved key for this provider','error')}showTestResult('Testing model...',true);const result=await api('POST','/test-model',{provider:prov,key,model});showTestResult(`Model Test: ${result.message}${result.response?'\\n\\nResponse: '+result.response:''}`,!result.success)}function showTestResult(text,pending=false){const div=document.getElementById('test-result');const pre=document.getElementById('test-result-text');div.style.display='block';pre.textContent=text;div.className=`p-3 rounded ${pending?'test-pending':''}`}function clearTestResult(){document.getElementById('test-result').style.display='none'}document.addEventListener('DOMContentLoaded',()=>{loadProviders().then(()=>{loadKeys();loadModels();loadSettings();loadLogs()})});document.querySelectorAll('[data-bs-toggle="pill"]').forEach(tab=>{tab.addEventListener('shown.bs.tab',(e)=>{const target=e.target.getAttribute('href');if(target==='#keys')loadKeys();else if(target==='#models')loadModels();else if(target==='#settings')loadSettings();else if(target==='#logs')loadLogs()})})</script></body></html>'''
@app.get("/",response_class=HTMLResponse)
async def web_ui(user:str=Depends(verify_admin)):return get_html()
if __name__=="__main__":
 import uvicorn;port=int(os.getenv("PORT",8000));uvicorn.run(app,host="0.0.0.0",port=port)
