from fastapi import FastAPI,HTTPException,Depends,Request,Form
from fastapi.responses import HTMLResponse,RedirectResponse,JSONResponse
from fastapi.security import HTTPBasic,HTTPBasicCredentials
from contextlib import asynccontextmanager
import sqlite3,secrets,json,os,threading,httpx,asyncio
from datetime import datetime
from typing import Optional
ADMIN_USER=os.getenv("ADMIN_USER","admin")
ADMIN_PASS=os.getenv("ADMIN_PASS","admin123")
BOT_SECRET=os.getenv("BOT_SECRET","bot_secret_key_123")
DB_PATH=os.getenv("DB_PATH","data/config.db")
db_lock=threading.Lock()
def get_db():
 os.makedirs(os.path.dirname(DB_PATH)if os.path.dirname(DB_PATH)else".",exist_ok=True)
 conn=sqlite3.connect(DB_PATH,check_same_thread=False);conn.row_factory=sqlite3.Row;return conn
def init_db():
 conn=get_db()
 conn.executescript('''CREATE TABLE IF NOT EXISTS api_keys(id INTEGER PRIMARY KEY AUTOINCREMENT,name TEXT UNIQUE NOT NULL,key_value TEXT NOT NULL,enabled INTEGER DEFAULT 1,created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP);
CREATE TABLE IF NOT EXISTS models(id INTEGER PRIMARY KEY AUTOINCREMENT,model_id TEXT UNIQUE NOT NULL,name TEXT NOT NULL,emoji TEXT DEFAULT 'ü§ñ',description TEXT,provider TEXT NOT NULL,endpoint TEXT,model_name TEXT NOT NULL,category TEXT DEFAULT 'custom',enabled INTEGER DEFAULT 1,priority INTEGER DEFAULT 100,config TEXT DEFAULT '{}',created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP);
CREATE TABLE IF NOT EXISTS settings(key TEXT PRIMARY KEY,value TEXT NOT NULL,updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP);
CREATE TABLE IF NOT EXISTS user_models(user_id TEXT PRIMARY KEY,model_id TEXT NOT NULL,updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP);
CREATE TABLE IF NOT EXISTS logs(id INTEGER PRIMARY KEY AUTOINCREMENT,action TEXT NOT NULL,details TEXT,ip TEXT,created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP);''')
 defaults={"default_model":"groq","bot_prefix":".","rate_limit_ai":"5","rate_limit_img":"15","system_prompt":"You are a helpful AI assistant.","max_memory_messages":"25","memory_timeout_minutes":"30"}
 for k,v in defaults.items():conn.execute('INSERT OR IGNORE INTO settings(key,value)VALUES(?,?)',(k,v))
 conn.commit();conn.close()
@asynccontextmanager
async def lifespan(app:FastAPI):
 init_db();yield
app=FastAPI(title="Bot Config Panel",lifespan=lifespan)
security=HTTPBasic()
def verify_admin(credentials:HTTPBasicCredentials=Depends(security)):
 if not(secrets.compare_digest(credentials.username,ADMIN_USER)and secrets.compare_digest(credentials.password,ADMIN_PASS)):
  raise HTTPException(status_code=401,detail="Unauthorized",headers={"WWW-Authenticate":"Basic"})
 return credentials.username
def verify_bot(request:Request):
 auth=request.headers.get("X-Bot-Secret","")
 if not secrets.compare_digest(auth,BOT_SECRET):raise HTTPException(status_code=401,detail="Invalid bot secret")
 return True
def add_log(action:str,details:str="",ip:str=""):
 with db_lock:
  conn=get_db();conn.execute('INSERT INTO logs(action,details,ip)VALUES(?,?,?)',(action,details,ip))
  conn.execute('DELETE FROM logs WHERE id NOT IN(SELECT id FROM logs ORDER BY created_at DESC LIMIT 500)')
  conn.commit();conn.close()
DEFAULT_MODELS={"groq":{"e":"‚ö°","n":"Groq","d":"Llama 3.3 70B - Ultra Fast","c":"main","p":"groq","m":"llama-3.3-70b-versatile"},"cerebras":{"e":"üß†","n":"Cerebras","d":"Llama 3.3 70B - Fast Inference","c":"main","p":"cerebras","m":"llama-3.3-70b"},"sambanova":{"e":"ü¶£","n":"SambaNova","d":"Llama 3.3 70B - Enterprise","c":"main","p":"sambanova","m":"Meta-Llama-3.3-70B-Instruct"},"cloudflare":{"e":"‚òÅÔ∏è","n":"Cloudflare","d":"Llama 3.3 70B - Edge AI","c":"main","p":"cloudflare","m":"@cf/meta/llama-3.3-70b-instruct-fp8-fast"},"cohere":{"e":"üî∑","n":"Cohere","d":"Command R+ - Advanced RAG","c":"main","p":"cohere","m":"command-r-plus-08-2024"},"mistral":{"e":"‚ìÇÔ∏è","n":"Mistral","d":"Mistral Small - Efficient","c":"main","p":"mistral","m":"mistral-small-latest"},"together":{"e":"ü§ù","n":"Together","d":"Llama 3.3 Turbo","c":"main","p":"together","m":"meta-llama/Llama-3.3-70B-Instruct-Turbo"},"moonshot":{"e":"üåô","n":"Moonshot","d":"Kimi 128K - Long Context","c":"main","p":"moonshot","m":"moonshot-v1-8k"},"huggingface":{"e":"ü§ó","n":"HuggingFace","d":"Mixtral 8x7B","c":"main","p":"huggingface","m":"mistralai/Mixtral-8x7B-Instruct-v0.1"},"replicate":{"e":"üîÑ","n":"Replicate","d":"Llama 405B - Largest","c":"main","p":"replicate","m":"meta/meta-llama-3.1-405b-instruct"},"tavily":{"e":"üîç","n":"Tavily","d":"Web Search AI","c":"main","p":"tavily","m":"search"},"or_llama":{"e":"ü¶ô","n":"OR-Llama","d":"Llama 3.3 70B via OpenRouter","c":"openrouter","p":"openrouter","m":"meta-llama/llama-3.3-70b-instruct:free"},"or_gemini":{"e":"üíé","n":"OR-Gemini","d":"Gemini 2.0 Flash","c":"openrouter","p":"openrouter","m":"google/gemini-2.0-flash-exp:free"},"or_qwen":{"e":"üíª","n":"OR-Qwen","d":"Qwen 2.5 72B","c":"openrouter","p":"openrouter","m":"qwen/qwen-2.5-72b-instruct:free"},"or_deepseek":{"e":"üåä","n":"OR-DeepSeek","d":"DeepSeek Chat","c":"openrouter","p":"openrouter","m":"deepseek/deepseek-chat:free"},"or_mistral":{"e":"üÖº","n":"OR-Mistral","d":"Mistral Nemo","c":"openrouter","p":"openrouter","m":"mistralai/mistral-nemo:free"},"pf_openai":{"e":"üÜì","n":"PollFree-OpenAI","d":"OpenAI Free","c":"pollinations_free","p":"pollinations_free","m":"openai"},"pf_claude":{"e":"üÜì","n":"PollFree-Claude","d":"Claude Free","c":"pollinations_free","p":"pollinations_free","m":"claude"},"pf_gemini":{"e":"üÜì","n":"PollFree-Gemini","d":"Gemini Free","c":"pollinations_free","p":"pollinations_free","m":"gemini"},"pf_deepseek":{"e":"üÜì","n":"PollFree-DeepSeek","d":"DeepSeek Free","c":"pollinations_free","p":"pollinations_free","m":"deepseek"},"pf_qwen":{"e":"üÜì","n":"PollFree-Qwen","d":"Qwen 72B Free","c":"pollinations_free","p":"pollinations_free","m":"qwen-72b"},"pf_llama":{"e":"üÜì","n":"PollFree-Llama","d":"Llama 3.3 Free","c":"pollinations_free","p":"pollinations_free","m":"llama"},"poll_free":{"e":"üå∏","n":"PollFree-Auto","d":"Auto Select Free","c":"pollinations_free","p":"pollinations_free","m":"auto"},"pa_openai":{"e":"üîë","n":"PollAPI-OpenAI","d":"OpenAI with API","c":"pollinations_api","p":"pollinations_api","m":"openai"},"pa_claude":{"e":"üîë","n":"PollAPI-Claude","d":"Claude with API","c":"pollinations_api","p":"pollinations_api","m":"claude"},"pa_gemini":{"e":"üîë","n":"PollAPI-Gemini","d":"Gemini with API","c":"pollinations_api","p":"pollinations_api","m":"gemini"},"pa_mistral":{"e":"üîë","n":"PollAPI-Mistral","d":"Mistral with API","c":"pollinations_api","p":"pollinations_api","m":"mistral"},"pa_deepseek":{"e":"üîë","n":"PollAPI-DeepSeek","d":"DeepSeek with API","c":"pollinations_api","p":"pollinations_api","m":"deepseek"}}
AI_PROVIDERS={"groq":{"name":"Groq","test_url":"https://api.groq.com/openai/v1/models","auth":"Bearer","models":["llama-3.3-70b-versatile","llama-3.1-8b-instant","mixtral-8x7b-32768"]},"openrouter":{"name":"OpenRouter","test_url":"https://openrouter.ai/api/v1/models","auth":"Bearer","models":["meta-llama/llama-3.3-70b-instruct:free","google/gemini-2.0-flash-exp:free"]},"cerebras":{"name":"Cerebras","test_url":"https://api.cerebras.ai/v1/models","auth":"Bearer","models":["llama-3.3-70b"]},"sambanova":{"name":"SambaNova","test_url":"https://api.sambanova.ai/v1/models","auth":"Bearer","models":["Meta-Llama-3.3-70B-Instruct"]},"together":{"name":"Together","test_url":"https://api.together.xyz/v1/models","auth":"Bearer","models":["meta-llama/Llama-3.3-70B-Instruct-Turbo"]},"mistral":{"name":"Mistral","test_url":"https://api.mistral.ai/v1/models","auth":"Bearer","models":["mistral-small-latest"]},"cohere":{"name":"Cohere","test_url":"https://api.cohere.com/v1/models","auth":"bearer","models":["command-r-plus-08-2024"]},"huggingface":{"name":"HuggingFace","test_url":"https://huggingface.co/api/whoami-v2","auth":"Bearer","models":["mistralai/Mixtral-8x7B-Instruct-v0.1"]},"openai":{"name":"OpenAI","test_url":"https://api.openai.com/v1/models","auth":"Bearer","models":["gpt-4o","gpt-4o-mini"]},"anthropic":{"name":"Anthropic","test_url":"https://api.anthropic.com/v1/messages","auth":"x-api-key","models":["claude-3-5-sonnet-20241022"]},"google":{"name":"Google AI","test_url":"https://generativelanguage.googleapis.com/v1/models","auth":"query","models":["gemini-1.5-pro"]},"deepseek":{"name":"DeepSeek","test_url":"https://api.deepseek.com/v1/models","auth":"Bearer","models":["deepseek-chat"]},"replicate":{"name":"Replicate","test_url":"https://api.replicate.com/v1/models","auth":"Bearer","models":["meta/meta-llama-3.1-405b-instruct"]},"tavily":{"name":"Tavily","test_url":"https://api.tavily.com/search","auth":"body","models":["search"]},"moonshot":{"name":"Moonshot","test_url":"https://api.moonshot.cn/v1/models","auth":"Bearer","models":["moonshot-v1-8k"]},"pollinations":{"name":"Pollinations","test_url":"https://text.pollinations.ai/","auth":"none","models":["openai","claude","gemini","mistral","deepseek"]}}
@app.get("/api/bot/keys")
async def bot_get_keys(request:Request,_:bool=Depends(verify_bot)):
 with db_lock:conn=get_db();rows=conn.execute('SELECT name,key_value FROM api_keys WHERE enabled=1').fetchall();conn.close()
 return{row["name"]:row["key_value"]for row in rows}
@app.get("/api/bot/models")
async def bot_get_models(request:Request,_:bool=Depends(verify_bot)):
 with db_lock:conn=get_db();rows=conn.execute('SELECT model_id,name,emoji,description,provider,endpoint,model_name,category,config FROM models WHERE enabled=1 ORDER BY priority ASC').fetchall();conn.close()
 models=DEFAULT_MODELS.copy()
 for row in rows:models[row["model_id"]]={"e":row["emoji"],"n":row["name"],"d":row["description"]or"","c":row["category"],"p":row["provider"],"m":row["model_name"],"endpoint":row["endpoint"]or"","config":json.loads(row["config"]or"{}")}
 return models
@app.get("/api/bot/settings")
async def bot_get_settings(request:Request,_:bool=Depends(verify_bot)):
 with db_lock:conn=get_db();rows=conn.execute('SELECT key,value FROM settings').fetchall();conn.close()
 return{row["key"]:row["value"]for row in rows}
@app.get("/api/bot/user-model/{user_id}")
async def bot_get_user_model(user_id:str,request:Request,_:bool=Depends(verify_bot)):
 with db_lock:conn=get_db();row=conn.execute('SELECT model_id FROM user_models WHERE user_id=?',(user_id,)).fetchone();conn.close()
 return{"model_id":row["model_id"]if row else None}
@app.post("/api/bot/user-model/{user_id}")
async def bot_set_user_model(user_id:str,request:Request,_:bool=Depends(verify_bot)):
 data=await request.json();model_id=data.get("model_id","groq")
 with db_lock:conn=get_db();conn.execute('INSERT OR REPLACE INTO user_models(user_id,model_id,updated_at)VALUES(?,?,CURRENT_TIMESTAMP)',(user_id,model_id));conn.commit();conn.close()
 return{"success":True}
@app.get("/api/bot/config")
async def bot_get_full_config(request:Request,_:bool=Depends(verify_bot)):
 with db_lock:
  conn=get_db()
  keys={row["name"]:row["key_value"]for row in conn.execute('SELECT name,key_value FROM api_keys WHERE enabled=1').fetchall()}
  db_models={}
  for row in conn.execute('SELECT*FROM models WHERE enabled=1 ORDER BY priority ASC').fetchall():
   db_models[row["model_id"]]={"e":row["emoji"],"n":row["name"],"d":row["description"]or"","c":row["category"],"p":row["provider"],"m":row["model_name"],"endpoint":row["endpoint"]or"","config":json.loads(row["config"]or"{}")}
  settings={row["key"]:row["value"]for row in conn.execute('SELECT key,value FROM settings').fetchall()}
  user_models={row["user_id"]:row["model_id"]for row in conn.execute('SELECT user_id,model_id FROM user_models').fetchall()}
  conn.close()
 models=DEFAULT_MODELS.copy();models.update(db_models)
 return{"keys":keys,"models":models,"settings":settings,"user_models":user_models,"timestamp":datetime.now().isoformat()}
@app.post("/api/bot/ping")
async def bot_ping(request:Request,_:bool=Depends(verify_bot)):
 add_log("bot_ping","",request.client.host if request.client else"");return{"status":"ok","timestamp":datetime.now().isoformat()}
@app.get("/api/admin/keys")
async def admin_list_keys(user:str=Depends(verify_admin)):
 with db_lock:conn=get_db();rows=conn.execute('SELECT id,name,key_value,enabled,created_at,updated_at FROM api_keys ORDER BY name').fetchall();conn.close()
 return[dict(row)for row in rows]
@app.post("/api/admin/keys")
async def admin_add_key(request:Request,user:str=Depends(verify_admin)):
 data=await request.json();name=data.get("name","").strip().lower();key_value=data.get("key","").strip()
 if not name or not key_value:raise HTTPException(status_code=400,detail="Name and key required")
 with db_lock:
  conn=get_db()
  try:conn.execute('INSERT INTO api_keys(name,key_value)VALUES(?,?)',(name,key_value));conn.commit()
  except sqlite3.IntegrityError:conn.close();raise HTTPException(status_code=400,detail="Key already exists")
  conn.close()
 add_log("add_key",f"Added:{name}",request.client.host if request.client else"");return{"success":True}
@app.put("/api/admin/keys/{key_id}")
async def admin_update_key(key_id:int,request:Request,user:str=Depends(verify_admin)):
 data=await request.json()
 with db_lock:
  conn=get_db()
  if"key"in data and data["key"]:conn.execute('UPDATE api_keys SET key_value=?,updated_at=CURRENT_TIMESTAMP WHERE id=?',(data["key"],key_id))
  if"enabled"in data:conn.execute('UPDATE api_keys SET enabled=?,updated_at=CURRENT_TIMESTAMP WHERE id=?',(1 if data["enabled"]else 0,key_id))
  conn.commit();conn.close()
 add_log("update_key",f"ID:{key_id}",request.client.host if request.client else"");return{"success":True}
@app.delete("/api/admin/keys/{key_id}")
async def admin_delete_key(key_id:int,request:Request,user:str=Depends(verify_admin)):
 with db_lock:conn=get_db();conn.execute('DELETE FROM api_keys WHERE id=?',(key_id,));conn.commit();conn.close()
 add_log("delete_key",f"ID:{key_id}",request.client.host if request.client else"");return{"success":True}
@app.get("/api/admin/models")
async def admin_list_models(user:str=Depends(verify_admin)):
 with db_lock:conn=get_db();rows=conn.execute('SELECT*FROM models ORDER BY category,priority,name').fetchall();conn.close()
 return[dict(row)for row in rows]
@app.get("/api/admin/default-models")
async def admin_get_default_models(user:str=Depends(verify_admin)):
 return DEFAULT_MODELS
@app.post("/api/admin/models")
async def admin_add_model(request:Request,user:str=Depends(verify_admin)):
 data=await request.json()
 for field in["model_id","name","provider","model_name"]:
  if not data.get(field):raise HTTPException(status_code=400,detail=f"Field '{field}' required")
 with db_lock:
  conn=get_db()
  try:
   conn.execute('INSERT INTO models(model_id,name,emoji,description,provider,endpoint,model_name,category,priority,config)VALUES(?,?,?,?,?,?,?,?,?,?)',(data["model_id"],data["name"],data.get("emoji","ü§ñ"),data.get("description",""),data["provider"],data.get("endpoint",""),data["model_name"],data.get("category","custom"),data.get("priority",100),json.dumps(data.get("config",{}))))
   conn.commit()
  except sqlite3.IntegrityError:conn.close();raise HTTPException(status_code=400,detail="Model ID exists")
  conn.close()
 add_log("add_model",data["model_id"],request.client.host if request.client else"");return{"success":True}
@app.put("/api/admin/models/{model_id}")
async def admin_update_model(model_id:int,request:Request,user:str=Depends(verify_admin)):
 data=await request.json();fields=[];values=[]
 for key in["name","emoji","description","provider","endpoint","model_name","category","priority","enabled"]:
  if key in data:fields.append(f"{key}=?");values.append(data[key])
 if"config"in data:fields.append("config=?");values.append(json.dumps(data["config"]))
 if fields:values.append(model_id)
 with db_lock:conn=get_db();conn.execute(f'UPDATE models SET {",".join(fields)} WHERE id=?',values);conn.commit();conn.close()
 add_log("update_model",f"ID:{model_id}",request.client.host if request.client else"");return{"success":True}
@app.delete("/api/admin/models/{model_id}")
async def admin_delete_model(model_id:int,request:Request,user:str=Depends(verify_admin)):
 with db_lock:conn=get_db();conn.execute('DELETE FROM models WHERE id=?',(model_id,));conn.commit();conn.close()
 add_log("delete_model",f"ID:{model_id}",request.client.host if request.client else"");return{"success":True}
@app.get("/api/admin/settings")
async def admin_list_settings(user:str=Depends(verify_admin)):
 with db_lock:conn=get_db();rows=conn.execute('SELECT*FROM settings ORDER BY key').fetchall();conn.close()
 return[dict(row)for row in rows]
@app.put("/api/admin/settings/{key}")
async def admin_update_setting(key:str,request:Request,user:str=Depends(verify_admin)):
 data=await request.json();value=data.get("value","")
 with db_lock:conn=get_db();conn.execute('INSERT OR REPLACE INTO settings(key,value,updated_at)VALUES(?,?,CURRENT_TIMESTAMP)',(key,value));conn.commit();conn.close()
 add_log("update_setting",key,request.client.host if request.client else"");return{"success":True}
@app.get("/api/admin/user-models")
async def admin_list_user_models(user:str=Depends(verify_admin)):
 with db_lock:conn=get_db();rows=conn.execute('SELECT*FROM user_models ORDER BY updated_at DESC').fetchall();conn.close()
 return[dict(row)for row in rows]
@app.post("/api/admin/user-models")
async def admin_set_user_model(request:Request,user:str=Depends(verify_admin)):
 data=await request.json();user_id=data.get("user_id","");model_id=data.get("model_id","groq")
 if not user_id:raise HTTPException(status_code=400,detail="user_id required")
 with db_lock:conn=get_db();conn.execute('INSERT OR REPLACE INTO user_models(user_id,model_id,updated_at)VALUES(?,?,CURRENT_TIMESTAMP)',(user_id,model_id));conn.commit();conn.close()
 add_log("set_user_model",f"{user_id}:{model_id}",request.client.host if request.client else"");return{"success":True}
@app.delete("/api/admin/user-models/{user_id}")
async def admin_delete_user_model(user_id:str,request:Request,user:str=Depends(verify_admin)):
 with db_lock:conn=get_db();conn.execute('DELETE FROM user_models WHERE user_id=?',(user_id,));conn.commit();conn.close()
 add_log("delete_user_model",user_id,request.client.host if request.client else"");return{"success":True}
@app.get("/api/admin/logs")
async def admin_list_logs(user:str=Depends(verify_admin)):
 with db_lock:conn=get_db();rows=conn.execute('SELECT*FROM logs ORDER BY created_at DESC LIMIT 100').fetchall();conn.close()
 return[dict(row)for row in rows]
@app.get("/api/admin/providers")
async def admin_get_providers(user:str=Depends(verify_admin)):
 return AI_PROVIDERS
@app.post("/api/admin/test-key")
async def admin_test_key(request:Request,user:str=Depends(verify_admin)):
 data=await request.json();provider=data.get("provider","");key=data.get("key","")
 if provider not in AI_PROVIDERS:return{"success":True,"message":"Provider not testable","tested":False}
 prov=AI_PROVIDERS[provider]
 try:
  async with httpx.AsyncClient()as client:
   headers={};params={}
   if prov["auth"]=="Bearer":headers["Authorization"]=f"Bearer {key}"
   elif prov["auth"]=="bearer":headers["Authorization"]=f"bearer {key}"
   elif prov["auth"]=="x-api-key":headers["x-api-key"]=key;headers["anthropic-version"]="2023-06-01"
   elif prov["auth"]=="query":params["key"]=key
   elif prov["auth"]=="body":
    resp=await client.post(prov["test_url"],json={"api_key":key,"query":"test","max_results":1},timeout=10)
    return{"success":resp.status_code==200,"message":"Valid"if resp.status_code==200 else f"HTTP {resp.status_code}","tested":True}
   elif prov["auth"]=="none":return{"success":True,"message":"No auth needed","tested":True}
   resp=await client.get(prov["test_url"],headers=headers,params=params,timeout=10)
   return{"success":resp.status_code==200,"message":"Valid ‚úì"if resp.status_code==200 else f"HTTP {resp.status_code}","tested":True}
 except Exception as e:return{"success":False,"message":str(e)[:50],"tested":True}
@app.post("/api/admin/test-all-keys")
async def admin_test_all_keys(request:Request,user:str=Depends(verify_admin)):
 with db_lock:conn=get_db();rows=conn.execute('SELECT name,key_value FROM api_keys WHERE enabled=1').fetchall();conn.close()
 results={}
 async with httpx.AsyncClient()as client:
  for row in rows:
   name=row["name"];key=row["key_value"]
   if name not in AI_PROVIDERS:results[name]={"success":True,"message":"Not testable","tested":False};continue
   prov=AI_PROVIDERS[name]
   try:
    headers={}
    if prov["auth"]=="Bearer":headers["Authorization"]=f"Bearer {key}"
    elif prov["auth"]=="bearer":headers["Authorization"]=f"bearer {key}"
    elif prov["auth"]=="none":results[name]={"success":True,"message":"No auth","tested":True};continue
    resp=await client.get(prov["test_url"],headers=headers,timeout=10)
    results[name]={"success":resp.status_code==200,"message":"Valid ‚úì"if resp.status_code==200 else f"Error","tested":True}
   except Exception as e:results[name]={"success":False,"message":str(e)[:30],"tested":True}
 return results
@app.get("/health")
async def health_check():return{"status":"ok","timestamp":datetime.now().isoformat()}
def get_html():
 return'''<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"><title>Bot Config Panel</title><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"><link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet"><style>:root{--primary:#5865F2;--dark:#1a1a2e;--darker:#16213e}body{background:linear-gradient(135deg,var(--dark),var(--darker));min-height:100vh;color:#fff}.navbar{background:rgba(0,0,0,0.3)!important;backdrop-filter:blur(10px)}.card{background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:15px}.card-header{background:rgba(255,255,255,0.05);border-bottom:1px solid rgba(255,255,255,0.1)}.table{color:#fff}.table-dark{background:transparent}.table-dark td,.table-dark th{border-color:rgba(255,255,255,0.1);background:transparent}.btn-primary{background:var(--primary);border:none}.form-control,.form-select{background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:#fff}.form-control:focus,.form-select:focus{background:rgba(255,255,255,0.15);border-color:var(--primary);color:#fff}.form-control::placeholder{color:rgba(255,255,255,0.5)}.modal-content{background:var(--darker);border:1px solid rgba(255,255,255,0.1)}.nav-pills .nav-link{color:rgba(255,255,255,0.7)}.nav-pills .nav-link.active{background:var(--primary)}.badge-enabled{background:#2ecc71}.badge-disabled{background:#e74c3c}.toast-container{position:fixed;top:20px;right:20px;z-index:9999}.model-card{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.1);border-radius:10px;padding:12px;margin-bottom:8px;cursor:pointer;transition:all 0.2s}.model-card:hover{background:rgba(255,255,255,0.08);border-color:var(--primary)}.model-card.selected{background:rgba(88,101,242,0.2);border-color:var(--primary)}.model-emoji{font-size:1.5rem}.category-badge{font-size:0.7rem;padding:2px 6px}</style></head><body><nav class="navbar navbar-expand-lg navbar-dark mb-4"><div class="container"><a class="navbar-brand" href="#"><i class="bi bi-gear-fill me-2"></i>Bot Config Panel</a><div class="navbar-nav ms-auto"><button class="btn btn-outline-light btn-sm me-2" onclick="testAllKeys()"><i class="bi bi-check-circle me-1"></i>Test All</button></div></div></nav><div class="container pb-5"><ul class="nav nav-pills mb-4" id="mainTab"><li class="nav-item"><a class="nav-link active" data-bs-toggle="pill" href="#models-tab"><i class="bi bi-robot me-1"></i>Models</a></li><li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#keys"><i class="bi bi-key me-1"></i>API Keys</a></li><li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#custom-models"><i class="bi bi-plus-circle me-1"></i>Custom Models</a></li><li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#settings"><i class="bi bi-sliders me-1"></i>Settings</a></li><li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#users"><i class="bi bi-people me-1"></i>User Models</a></li><li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#logs"><i class="bi bi-list-ul me-1"></i>Logs</a></li></ul><div class="tab-content"><div class="tab-pane fade show active" id="models-tab"><div class="row"><div class="col-lg-8"><div class="card"><div class="card-header"><h5 class="mb-0"><i class="bi bi-robot me-2"></i>Available Models (Click to set as default)</h5></div><div class="card-body"><div class="row mb-3"><div class="col"><input type="text" class="form-control" id="model-search" placeholder="üîç Search models..." onkeyup="filterModels()"></div></div><div id="models-grid"></div></div></div></div><div class="col-lg-4"><div class="card mb-3"><div class="card-header"><h6 class="mb-0"><i class="bi bi-star me-2"></i>Current Default</h6></div><div class="card-body"><div id="current-default" class="text-center py-3"><span class="text-muted">Loading...</span></div></div></div><div class="card"><div class="card-header"><h6 class="mb-0"><i class="bi bi-bar-chart me-2"></i>Categories</h6></div><div class="card-body" id="category-stats"></div></div></div></div></div><div class="tab-pane fade" id="keys"><div class="card"><div class="card-header d-flex justify-content-between align-items-center"><h5 class="mb-0"><i class="bi bi-key me-2"></i>API Keys</h5><button class="btn btn-primary btn-sm" onclick="showAddKeyModal()"><i class="bi bi-plus-lg me-1"></i>Add</button></div><div class="card-body"><table class="table table-dark table-hover"><thead><tr><th>Provider</th><th>Key</th><th>Status</th><th>Actions</th></tr></thead><tbody id="keys-table"></tbody></table></div></div></div><div class="tab-pane fade" id="custom-models"><div class="card"><div class="card-header d-flex justify-content-between align-items-center"><h5 class="mb-0"><i class="bi bi-plus-circle me-2"></i>Custom Models</h5><button class="btn btn-primary btn-sm" onclick="showAddModelModal()"><i class="bi bi-plus-lg me-1"></i>Add Model</button></div><div class="card-body"><table class="table table-dark table-hover"><thead><tr><th>ID</th><th>Name</th><th>Provider</th><th>Status</th><th>Actions</th></tr></thead><tbody id="custom-models-table"></tbody></table></div></div></div><div class="tab-pane fade" id="settings"><div class="card"><div class="card-header"><h5 class="mb-0"><i class="bi bi-sliders me-2"></i>Bot Settings</h5></div><div class="card-body"><form id="settings-form"><div class="row g-3" id="settings-fields"></div><div class="mt-4"><button type="submit" class="btn btn-primary"><i class="bi bi-save me-1"></i>Save Settings</button></div></form></div></div></div><div class="tab-pane fade" id="users"><div class="card"><div class="card-header d-flex justify-content-between align-items-center"><h5 class="mb-0"><i class="bi bi-people me-2"></i>User Model Assignments</h5><button class="btn btn-primary btn-sm" onclick="showAddUserModelModal()"><i class="bi bi-plus-lg me-1"></i>Add User</button></div><div class="card-body"><table class="table table-dark table-hover"><thead><tr><th>User ID</th><th>Model</th><th>Updated</th><th>Actions</th></tr></thead><tbody id="users-table"></tbody></table></div></div></div><div class="tab-pane fade" id="logs"><div class="card"><div class="card-header d-flex justify-content-between align-items-center"><h5 class="mb-0"><i class="bi bi-list-ul me-2"></i>Logs</h5><button class="btn btn-outline-light btn-sm" onclick="loadLogs()"><i class="bi bi-arrow-clockwise"></i></button></div><div class="card-body"><div style="max-height:400px;overflow-y:auto"><table class="table table-dark table-sm"><thead><tr><th>Time</th><th>Action</th><th>Details</th></tr></thead><tbody id="logs-table"></tbody></table></div></div></div></div></div></div><div class="modal fade" id="addKeyModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Add API Key</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><form id="add-key-form"><div class="modal-body"><div class="mb-3"><label class="form-label">Provider</label><select class="form-select" id="key-name" required></select></div><div class="mb-3"><label class="form-label">API Key</label><input type="text" class="form-control" id="key-value" required placeholder="sk-xxx..."></div><div id="key-test-result"></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="button" class="btn btn-info" onclick="testNewKey()">Test</button><button type="submit" class="btn btn-primary">Add</button></div></form></div></div></div><div class="modal fade" id="addModelModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Add Custom Model</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><form id="add-model-form"><div class="modal-body"><div class="row g-3"><div class="col-md-6"><label class="form-label">Model ID</label><input type="text" class="form-control" id="model-id" required placeholder="my_model"></div><div class="col-md-4"><label class="form-label">Name</label><input type="text" class="form-control" id="model-name" required placeholder="My Model"></div><div class="col-md-2"><label class="form-label">Emoji</label><input type="text" class="form-control" id="model-emoji" value="ü§ñ"></div><div class="col-md-6"><label class="form-label">Provider</label><select class="form-select" id="model-provider" required></select></div><div class="col-md-6"><label class="form-label">Category</label><select class="form-select" id="model-category"><option value="main">Main</option><option value="openrouter">OpenRouter</option><option value="pollinations_free">Pollinations Free</option><option value="pollinations_api">Pollinations API</option><option value="custom">Custom</option></select></div><div class="col-12"><label class="form-label">Model Name (API)</label><input type="text" class="form-control" id="model-model-name" required placeholder="llama-3.3-70b"></div><div class="col-12"><label class="form-label">Description</label><input type="text" class="form-control" id="model-description" placeholder="Description"></div></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="submit" class="btn btn-primary">Add Model</button></div></form></div></div></div><div class="modal fade" id="addUserModelModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Set User Model</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><form id="add-user-model-form"><div class="modal-body"><div class="mb-3"><label class="form-label">Discord User ID</label><input type="text" class="form-control" id="user-id" required placeholder="123456789012345678"></div><div class="mb-3"><label class="form-label">Model</label><select class="form-select" id="user-model" required></select></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="submit" class="btn btn-primary">Set Model</button></div></form></div></div></div><div class="toast-container" id="toast-container"></div><script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script><script>let allModels={},providers={},currentDefault='groq';function showToast(msg,type='success'){const c=document.getElementById('toast-container');const t=document.createElement('div');t.className=`toast show bg-${type==='success'?'success':'danger'} text-white`;t.innerHTML=`<div class="toast-body">${msg}<button class="btn-close btn-close-white ms-2 float-end" onclick="this.parentElement.parentElement.remove()"></button></div>`;c.appendChild(t);setTimeout(()=>t.remove(),3000)}async function api(method,endpoint,data=null){const opt={method,headers:{'Content-Type':'application/json'}};if(data)opt.body=JSON.stringify(data);const r=await fetch(`/api/admin${endpoint}`,opt);if(r.status===401){location.reload();return null}return r.json()}async function loadProviders(){providers=await api('GET','/providers');const s1=document.getElementById('key-name');const s2=document.getElementById('model-provider');s1.innerHTML='<option value="">Select...</option>';s2.innerHTML='';for(const[k,v]of Object.entries(providers)){s1.innerHTML+=`<option value="${k}">${v.name}</option>`;s2.innerHTML+=`<option value="${k}">${v.name}</option>`}}async function loadModels(){const dm=await api('GET','/default-models');const cm=await api('GET','/models');allModels={...dm};cm.forEach(m=>{allModels[m.model_id]={e:m.emoji,n:m.name,d:m.description,c:m.category,p:m.provider,m:m.model_name,custom:true,id:m.id}});const settings=await api('GET','/settings');const defSetting=settings.find(s=>s.key==='default_model');currentDefault=defSetting?defSetting.value:'groq';renderModels();renderCurrentDefault();renderCategoryStats();loadUserModelSelect()}function renderModels(){const grid=document.getElementById('models-grid');const search=document.getElementById('model-search').value.toLowerCase();const cats={main:[],openrouter:[],pollinations_free:[],pollinations_api:[],custom:[]};for(const[id,m]of Object.entries(allModels)){if(search&&!m.n.toLowerCase().includes(search)&&!id.includes(search))continue;const cat=m.c||'main';if(!cats[cat])cats[cat]=[];cats[cat].push({id,...m})}let html='';const catNames={main:'‚ö° Main Providers',openrouter:'üåê OpenRouter',pollinations_free:'üÜì Pollinations Free',pollinations_api:'üîë Pollinations API',custom:'‚öôÔ∏è Custom'};for(const[cat,models]of Object.entries(cats)){if(!models.length)continue;html+=`<h6 class="mt-3 mb-2">${catNames[cat]||cat} (${models.length})</h6><div class="row">`;for(const m of models){const sel=m.id===currentDefault?'selected':'';html+=`<div class="col-md-6 col-lg-4"><div class="model-card ${sel}" onclick="setDefaultModel('${m.id}')"><div class="d-flex align-items-center"><span class="model-emoji me-2">${m.e}</span><div class="flex-grow-1"><strong>${m.n}</strong><br><small class="text-muted">${m.d||m.m}</small></div>${sel?'<i class="bi bi-check-circle-fill text-success"></i>':''}</div></div></div>`}html+=`</div>`}grid.innerHTML=html||'<p class="text-muted">No models found</p>'}function filterModels(){renderModels()}function renderCurrentDefault(){const el=document.getElementById('current-default');const m=allModels[currentDefault];if(m){el.innerHTML=`<span class="model-emoji" style="font-size:2rem">${m.e}</span><h5 class="mt-2 mb-1">${m.n}</h5><small class="text-muted">${currentDefault}</small><br><code class="small">${m.m}</code>`}else{el.innerHTML=`<span class="text-muted">${currentDefault}</span>`}}function renderCategoryStats(){const cats={};for(const m of Object.values(allModels)){const c=m.c||'main';cats[c]=(cats[c]||0)+1}const el=document.getElementById('category-stats');el.innerHTML=Object.entries(cats).map(([c,n])=>`<div class="d-flex justify-content-between mb-2"><span>${c}</span><span class="badge bg-secondary">${n}</span></div>`).join('')}async function setDefaultModel(modelId){await api('PUT','/settings/default_model',{value:modelId});currentDefault=modelId;renderModels();renderCurrentDefault();showToast(`Default set to ${allModels[modelId]?.n||modelId}`)}async function loadKeys(){const keys=await api('GET','/keys');document.getElementById('keys-table').innerHTML=keys.map(k=>`<tr><td><strong>${k.name}</strong></td><td><code>‚Ä¢‚Ä¢‚Ä¢‚Ä¢${(k.key_value||'').slice(-4)}</code></td><td><span class="badge ${k.enabled?'badge-enabled':'badge-disabled'}">${k.enabled?'On':'Off'}</span></td><td><button class="btn btn-sm btn-outline-light me-1" onclick="toggleKey(${k.id},${!k.enabled})"><i class="bi bi-power"></i></button><button class="btn btn-sm btn-outline-danger" onclick="deleteKey(${k.id},'${k.name}')"><i class="bi bi-trash"></i></button></td></tr>`).join('')}function showAddKeyModal(){document.getElementById('add-key-form').reset();document.getElementById('key-test-result').innerHTML='';new bootstrap.Modal(document.getElementById('addKeyModal')).show()}document.getElementById('add-key-form').addEventListener('submit',async e=>{e.preventDefault();const r=await api('POST','/keys',{name:document.getElementById('key-name').value,key:document.getElementById('key-value').value});if(r?.success){showToast('Key added');bootstrap.Modal.getInstance(document.getElementById('addKeyModal')).hide();loadKeys()}else showToast(r?.detail||'Error','error')});async function testNewKey(){const p=document.getElementById('key-name').value;const k=document.getElementById('key-value').value;if(!p||!k)return showToast('Select provider and enter key','error');document.getElementById('key-test-result').innerHTML='<span class="text-warning">Testing...</span>';const r=await api('POST','/test-key',{provider:p,key:k});document.getElementById('key-test-result').innerHTML=`<span class="text-${r.success?'success':'danger'}">${r.message}</span>`}async function toggleKey(id,en){await api('PUT',`/keys/${id}`,{enabled:en});loadKeys()}async function deleteKey(id,name){if(confirm(`Delete ${name}?`)){await api('DELETE',`/keys/${id}`);showToast('Deleted');loadKeys()}}async function testAllKeys(){showToast('Testing all keys...');const r=await api('POST','/test-all-keys');let msg='Results:\\n';for(const[k,v]of Object.entries(r))msg+=`${v.success?'‚úì':'‚úó'} ${k}\\n`;alert(msg)}async function loadCustomModels(){const models=await api('GET','/models');document.getElementById('custom-models-table').innerHTML=models.length?models.map(m=>`<tr><td><code>${m.model_id}</code></td><td>${m.emoji} ${m.name}</td><td>${m.provider}</td><td><span class="badge ${m.enabled?'badge-enabled':'badge-disabled'}">${m.enabled?'On':'Off'}</span></td><td><button class="btn btn-sm btn-outline-light me-1" onclick="toggleModel(${m.id},${!m.enabled})"><i class="bi bi-power"></i></button><button class="btn btn-sm btn-outline-danger" onclick="deleteModel(${m.id})"><i class="bi bi-trash"></i></button></td></tr>`).join(''):'<tr><td colspan="5" class="text-center text-muted">No custom models</td></tr>'}function showAddModelModal(){document.getElementById('add-model-form').reset();document.getElementById('model-emoji').value='ü§ñ';new bootstrap.Modal(document.getElementById('addModelModal')).show()}document.getElementById('add-model-form').addEventListener('submit',async e=>{e.preventDefault();const r=await api('POST','/models',{model_id:document.getElementById('model-id').value,name:document.getElementById('model-name').value,emoji:document.getElementById('model-emoji').value,provider:document.getElementById('model-provider').value,model_name:document.getElementById('model-model-name').value,category:document.getElementById('model-category').value,description:document.getElementById('model-description').value,priority:100});if(r?.success){showToast('Model added');bootstrap.Modal.getInstance(document.getElementById('addModelModal')).hide();loadCustomModels();loadModels()}else showToast(r?.detail||'Error','error')});async function toggleModel(id,en){await api('PUT',`/models/${id}`,{enabled:en?1:0});loadCustomModels()}async function deleteModel(id){if(confirm('Delete model?')){await api('DELETE',`/models/${id}`);showToast('Deleted');loadCustomModels();loadModels()}}async function loadSettings(){const settings=await api('GET','/settings');const info={default_model:{label:'Default Model',type:'select'},bot_prefix:{label:'Bot Prefix',type:'text'},rate_limit_ai:{label:'AI Rate Limit (sec)',type:'number'},rate_limit_img:{label:'Image Rate Limit (sec)',type:'number'},system_prompt:{label:'System Prompt',type:'textarea'},max_memory_messages:{label:'Max Memory',type:'number'},memory_timeout_minutes:{label:'Memory Timeout (min)',type:'number'}};let html='';for(const s of settings){const i=info[s.key]||{label:s.key,type:'text'};if(s.key==='default_model'){html+=`<div class="col-md-6"><label class="form-label">${i.label}</label><select class="form-select" name="${s.key}" id="setting-default-model"></select></div>`}else if(i.type==='textarea'){html+=`<div class="col-12"><label class="form-label">${i.label}</label><textarea class="form-control" name="${s.key}" rows="2">${s.value}</textarea></div>`}else{html+=`<div class="col-md-6"><label class="form-label">${i.label}</label><input type="${i.type}" class="form-control" name="${s.key}" value="${s.value}"></div>`}}document.getElementById('settings-fields').innerHTML=html;setTimeout(()=>{const sel=document.getElementById('setting-default-model');if(sel){sel.innerHTML=Object.entries(allModels).map(([id,m])=>`<option value="${id}" ${id===currentDefault?'selected':''}>${m.e} ${m.n}</option>`).join('')}},100)}document.getElementById('settings-form').addEventListener('submit',async e=>{e.preventDefault();const fd=new FormData(e.target);for(const[k,v]of fd.entries())await api('PUT',`/settings/${k}`,{value:v});showToast('Settings saved');loadModels()});function loadUserModelSelect(){const sel=document.getElementById('user-model');sel.innerHTML=Object.entries(allModels).map(([id,m])=>`<option value="${id}">${m.e} ${m.n}</option>`).join('')}async function loadUserModels(){const users=await api('GET','/user-models');document.getElementById('users-table').innerHTML=users.length?users.map(u=>{const m=allModels[u.model_id]||{e:'‚ùì',n:u.model_id};return`<tr><td><code>${u.user_id}</code></td><td>${m.e} ${m.n}</td><td><small>${new Date(u.updated_at).toLocaleDateString()}</small></td><td><button class="btn btn-sm btn-outline-danger" onclick="deleteUserModel('${u.user_id}')"><i class="bi bi-trash"></i></button></td></tr>`}).join(''):'<tr><td colspan="4" class="text-center text-muted">No user assignments</td></tr>'}function showAddUserModelModal(){document.getElementById('add-user-model-form').reset();new bootstrap.Modal(document.getElementById('addUserModelModal')).show()}document.getElementById('add-user-model-form').addEventListener('submit',async e=>{e.preventDefault();const r=await api('POST','/user-models',{user_id:document.getElementById('user-id').value,model_id:document.getElementById('user-model').value});if(r?.success){showToast('User model set');bootstrap.Modal.getInstance(document.getElementById('addUserModelModal')).hide();loadUserModels()}else showToast(r?.detail||'Error','error')});async function deleteUserModel(uid){if(confirm('Remove user assignment?')){await api('DELETE',`/user-models/${uid}`);showToast('Removed');loadUserModels()}}async function loadLogs(){const logs=await api('GET','/logs');document.getElementById('logs-table').innerHTML=logs.map(l=>`<tr><td><small>${new Date(l.created_at).toLocaleString()}</small></td><td><code>${l.action}</code></td><td><small>${l.details||'-'}</small></td></tr>`).join('')}document.addEventListener('DOMContentLoaded',async()=>{await loadProviders();await loadModels();loadKeys();loadCustomModels();loadSettings();loadUserModels();loadLogs()});document.querySelectorAll('[data-bs-toggle="pill"]').forEach(t=>{t.addEventListener('shown.bs.tab',e=>{const h=e.target.getAttribute('href');if(h==='#keys')loadKeys();else if(h==='#custom-models')loadCustomModels();else if(h==='#settings')loadSettings();else if(h==='#users')loadUserModels();else if(h==='#logs')loadLogs();else if(h==='#models-tab')loadModels()})})</script></body></html>'''
@app.get("/",response_class=HTMLResponse)
async def web_ui(user:str=Depends(verify_admin)):return get_html()
if __name__=="__main__":
 import uvicorn;port=int(os.getenv("PORT",8000));uvicorn.run(app,host="0.0.0.0",port=port)
